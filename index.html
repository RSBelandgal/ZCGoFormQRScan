<!DOCTYPE html>
<html>
<head>
  <title>Google Sheet Search Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 1000px; 
      margin: 40px auto; 
      position: relative;
      background: #ffffff;
      color: #000000;
      transition: background 0.3s, color 0.3s;
      padding: 10px; /* add padding for mobile sides */
    }
    body.dark { background: #121212; color: #f1f1f1; }

    #topHeader { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; flex-wrap: wrap; }
    #developer { font-size: 14px; color: #555; }
    body.dark #developer { color: #ccc; }
    #sheetInfo { text-align: right; font-size: 14px; color: #555; }
    body.dark #sheetInfo { color: #bbb; }

    #sheetInfo #status {
      margin-top: 4px;
      font-weight: bold;
      color: green;
    }
    body.dark #sheetInfo #status { color: #80e080; }

    #searchBox { padding: 8px; width: 50%; margin-right: 10px; margin-bottom:10px; min-width: 120px; }
    #searchField { padding: 8px; width: 180px; margin-right: 10px; margin-bottom:10px; min-width: 120px; }
    #searchBtn, #clearBtn, #scanBtn, #uploadBtn, #darkModeBtn { 
      padding: 9px 15px; border: none; color: white; cursor: pointer; margin-bottom:10px; border-radius: 5px;
      transition: background 0.3s, color 0.3s;
      position: relative;
      white-space: nowrap;
    }
    #searchBtn { background: #4285F4; margin-right: 5px; }
    #searchBtn:hover { background: #357AE8; }
    #clearBtn { background: #f44336; margin-right: 5px; }
    #clearBtn:hover { background: #d32f2f; }
    #scanBtn { background: #4CAF50; margin-right: 5px; }
    #scanBtn:hover { background: #45a049; }
    #uploadBtn { background: #FF9800; }
    #uploadBtn:hover { background: #e68900; }
    #darkModeBtn { background: #333; margin-left: 5px; }
    body.dark #darkModeBtn { background: #666; color: #fff; }

    /* Spinner */
    .spinner {
      border: 2px solid #f3f3f3; 
      border-top: 2px solid #fff; 
      border-radius: 50%;
      width: 14px;
      height: 14px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-left: 5px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Button row */
    #scanUploadWrap {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      position: relative;
      flex-wrap: wrap; /* allows wrapping on small screens */
    }

    #validatedMsg { 
      font-weight: bold; 
      display: none; 
      font-size: 25px; 
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
    }

    #fields { margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; border: 1px solid #ddd; }
    body.dark #fields { background: #1e1e1e; border-color: #444; }
    .field { display: flex; margin-bottom: 6px; flex-wrap: wrap; }
    .field-name { font-weight: bold; min-width: 200px; color: #333; white-space: nowrap; }
    body.dark .field-name { color: #ddd; }
    .field-value { flex: 1; color: #555; word-wrap: break-word; }
    body.dark .field-value { color: #ccc; }

    #counter { margin-top: 10px; font-weight: bold; color: #444; }
    body.dark #counter { color: #ccc; }

    #results { margin-top: 10px; border-collapse: collapse; width: 100%; overflow-x:auto; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; word-wrap: break-word; }
    th { background-color: #4285F4; color: white; font-weight: bold; text-align: left; }
    tr:hover { background-color: #e8f0fe; cursor: pointer; }
    body.dark th { background-color: #333; border-color: #555; }
    body.dark td { border-color: #555; }
    body.dark tr:hover { background-color: #444; }

    #reader { width: 100%; max-width: 400px; margin: 15px 0; display: none; }
    #uploadQR { display: none; }

    /* Mobile responsive tweaks: keep layout same but scale/fix widths */
    @media screen and (max-width: 768px) {
      body { padding: 5px; }
      #searchBox, #searchField { width: auto; max-width: 100%; }
      #searchBtn, #clearBtn, #scanBtn, #uploadBtn, #darkModeBtn { font-size: 14px; padding: 7px 12px; }
      #fields { padding: 10px; }
      #validatedMsg { font-size: 20px; }
      #reader { max-width: 100%; }
      #topHeader { flex-direction: column; align-items: flex-start; gap: 5px; }
      #sheetInfo { text-align: left; margin-top: 5px; }
    }
  </style>
</head>
<body>
  <div id="topHeader">
    <div id="developer">Developer: Rodney Belangdal</div>
    <div id="sheetInfo">
      <div id="totalRecords">Total Records: 0</div>
      <div id="sheetName">&nbsp;</div>
      <div id="status">Loading dataâ€¦</div>
    </div>
  </div>

  <h2 style="margin-top: 0; margin-bottom: 10px;">LUZAD ZONING CERTIFICATION VERIFICATION @ CPDO2025</h2>
  <select id="searchField"></select>
  <input type="text" id="searchBox" placeholder="Search..." />
  <button id="searchBtn">Search</button>
  <button id="clearBtn">Clear</button>

  <span id="scanUploadWrap">
    <button id="scanBtn">Scan QR</button>
    <button id="uploadBtn">Upload QR</button>
    <button id="darkModeBtn">ðŸŒ™ Dark Mode</button>
    <span id="validatedMsg">VALIDATED DATA!</span>
  </span>

  <input type="file" id="uploadQR" accept="image/*">
  <div id="reader"></div>

  <div id="fields">
    <div class="field"><span class="field-name">DATE RECEIPT :</span><span class="field-value" id="DATE RECEIPT">&nbsp;</span></div>
    <div class="field"><span class="field-name">RELEASED DATE :</span><span class="field-value" id="RELEASED_D">&nbsp;</span></div>
    <div class="field"><span class="field-name">CONTROL NO :</span><span class="field-value" id="CONTROL NO">&nbsp;</span></div>
    <div class="field"><span class="field-name">PIN :</span><span class="field-value" id="PIN">&nbsp;</span></div>
    <div class="field"><span class="field-name">NEW PIN :</span><span class="field-value" id="NEW PIN">&nbsp;</span></div>
    <div class="field"><span class="field-name">APPLICANT NAME :</span><span class="field-value" id="APPLICANT NAME">&nbsp;</span></div>
    <div class="field"><span class="field-name">LOT/SURVEY NO :</span><span class="field-value" id="LOT/SURVEY NO">&nbsp;</span></div>
    <div class="field"><span class="field-name">LAND AREA :</span><span class="field-value" id="LAND AREA">&nbsp;</span></div>
    <div class="field"><span class="field-name">BARANGAY :</span><span class="field-value" id="BARANGAYID_F">&nbsp;</span></div>
    <div class="field"><span class="field-name">ZONE CLASS :</span><span class="field-value" id="CLASSIFICATIONID_F">&nbsp;</span></div>
    <div class="field"><span class="field-name">PLUSCODE :</span><span class="field-value" id="PLUSCODES">&nbsp;</span></div>
    <div class="field"><span class="field-name">OR NO :</span><span class="field-value" id="OR NO">&nbsp;</span></div>
    <div class="field"><span class="field-name">OR DATE :</span><span class="field-value" id="OR DATE">&nbsp;</span></div>
    <div class="field"><span class="field-name">REMARKS :</span><span class="field-value" id="REMARKS">&nbsp;</span></div>
  </div>

  <div id="counter"></div>
  <div id="results"></div>

  <!-- JS (same as before) -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    const apiURL = "https://script.google.com/macros/s/AKfycbzl2hyJ6R807HCLGRZXPgniqPhuHpxJpSIEzy3cXE-W9Otnr6RUGh5L9TxB7OMgns3i/exec";
    let sheetData = [];
    let totalRecords = 0;
    let html5QrCode;

    const FIELDS_TO_SHOW = [ "DATE RECEIPT", "RELEASED_D", "CONTROL NO", "PIN", "NEW PIN", "APPLICANT NAME", "LOT/SURVEY NO", "LAND AREA", "BARANGAYID_F", "CLASSIFICATIONID_F", "PLUSCODES", "OR NO", "OR DATE", "REMARKS" ];
    const SEARCHABLE_FIELDS = [ "CONTROL NO", "PIN", "NEW PIN", "APPLICANT NAME", "LOT/SURVEY NO" ];

    const dropdown = document.getElementById("searchField");
    SEARCHABLE_FIELDS.forEach(field => {
      const option = document.createElement("option");
      option.value = field;
      option.textContent = field;
      dropdown.appendChild(option);
    });

    async function loadData() {
      const statusDiv = document.getElementById("status");
      const scanBtn = document.getElementById("scanBtn");
      const uploadBtn = document.getElementById("uploadBtn");

      scanBtn.disabled = true;
      uploadBtn.disabled = true;
      scanBtn.innerHTML = 'Scan QR <span class="spinner"></span>';
      uploadBtn.innerHTML = 'Upload QR <span class="spinner"></span>';
      statusDiv.textContent = "Loading data please waitâ€¦";

      try {
        const res = await fetch(apiURL);
        if (!res.ok) throw new Error("HTTP error " + res.status);
        const rawData = await res.json();

        if (!rawData || !Array.isArray(rawData.data) || rawData.data.length < 2) {
          statusDiv.textContent = "No data or invalid format returned.";
          return;
        }

        const headers = rawData.data[0];
        sheetData = rawData.data.slice(1).map(row => {
          let obj = {};
          headers.forEach((h, i) => obj[h] = row[i]);
          return obj;
        });

        totalRecords = sheetData.length;
        document.getElementById("totalRecords").textContent = `Total Records: ${totalRecords}`;
        document.getElementById("sheetName").textContent = rawData.spreadsheetName || "Unknown Sheet";

        clearResults();
        statusDiv.textContent = "Data loaded. You can now search.";
      } catch(err) {
        console.error("Error loading data:", err);
        statusDiv.textContent = "Failed to load data. See console for details.";
      } finally {
        scanBtn.disabled = false;
        uploadBtn.disabled = false;
        scanBtn.innerHTML = 'Scan QR';
        uploadBtn.innerHTML = 'Upload QR';
      }
    }

    function formatDate(dateStr) {
      if (!dateStr) return "\u00A0";
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      return d.toLocaleDateString('en-US', options);
    }

    function fillFields(row) {
      FIELDS_TO_SHOW.forEach(field => {
        const el = document.getElementById(field);
        if(el) {
          if(["DATE RECEIPT", "RELEASED_D", "OR DATE"].includes(field)) {
            el.textContent = formatDate(row[field]);
          } else {
            el.textContent = row[field] || "\u00A0";
          }
        }
      });
    }

    function clearFields() {
      FIELDS_TO_SHOW.forEach(field => {
        const el = document.getElementById(field);
        if(el) el.textContent = "\u00A0";
      });
    }

    function showResults(data) {
      const resultsDiv = document.getElementById("results");
      const counterDiv = document.getElementById("counter");
      resultsDiv.innerHTML = "";
      counterDiv.textContent = `Showing ${data.length} of ${totalRecords} record(s)`;

      if(data.length === 0) return;

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      ["CONTROL NO", "APPLICANT NAME", "LOT/SURVEY NO", "ZONING CLASSIFICATION", "BARANGAY"].forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      data.forEach(row => {
        const tr = document.createElement("tr");
        ["CONTROL NO", "APPLICANT NAME", "LOT/SURVEY NO", "CLASSIFICATIONID_F", "BARANGAYID_F"].forEach(col => {
          const td = document.createElement("td");
          td.textContent = row[col] || "";
          tr.appendChild(td);
        });
        tr.addEventListener("click", () => fillFields(row));
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      resultsDiv.appendChild(table);
    }

    function clearResults() {
      document.getElementById("results").innerHTML = "";
      document.getElementById("counter").textContent = "";
      document.getElementById("validatedMsg").style.display = "none";
    }

    function runSearch() {
      if (sheetData.length === 0) return;

      const query = document.getElementById("searchBox").value.trim().toLowerCase();
      const selectedField = document.getElementById("searchField").value;
      const validatedMsg = document.getElementById("validatedMsg");

      if(!query) {
        clearResults();
        clearFields();
        validatedMsg.style.display = "none";
        return;
      }

      const filtered = sheetData.filter(row => {
        return row[selectedField] && String(row[selectedField]).trim().toLowerCase() === query;
      });

      showResults(filtered);

      if (filtered.length > 0) {
        fillFields(filtered[0]);
        validatedMsg.textContent = "VALIDATED DATA!";
        validatedMsg.style.color = "green";
        validatedMsg.style.display = "inline";
      } else {
        clearFields();
        validatedMsg.textContent = "NO RECORD FOUND!";
        validatedMsg.style.color = "red";
        validatedMsg.style.display = "inline";
      }
    }

    function clearSearch() {
      document.getElementById("searchBox").value = "";
      clearResults();
      clearFields();
      document.getElementById("searchBox").focus();
    }

    // QR Scanner
    function startScanner() {
      const reader = document.getElementById("reader");
      reader.style.display = "block";
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess
      ).catch(err => console.error("Unable to start scanner:", err));
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          document.getElementById("reader").style.display = "none";
        }).catch(err => console.error("Failed to stop scanner:", err));
      }
    }

    function onScanSuccess(decodedText) {
      document.getElementById("searchBox").value = decodedText;
      document.getElementById("searchField").value = "CONTROL NO";
      runSearch();
      stopScanner();
    }

    // QR Upload
    document.getElementById("uploadBtn").addEventListener("click", () => {
      document.getElementById("uploadQR").click();
    });

    document.getElementById("uploadQR").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function() {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          if (code) {
            document.getElementById("searchBox").value = code.data;
            document.getElementById("searchField").value = "CONTROL NO";
            runSearch();
          } else {
            alert("No QR code found in the uploaded image.");
          }
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });

    document.getElementById("scanBtn").addEventListener("click", startScanner);
    document.getElementById("searchBtn").addEventListener("click", runSearch);
    document.getElementById("clearBtn").addEventListener("click", clearSearch);
    document.getElementById("searchBox").addEventListener("input", runSearch);
    document.getElementById("searchBox").addEventListener("keypress", e => {
      if(e.key === "Enter") { e.preventDefault(); runSearch(); }
    });

    // Dark Mode
    const darkModeBtn = document.getElementById("darkModeBtn");
    function setDarkMode(enabled) {
      if (enabled) {
        document.body.classList.add("dark");
        darkModeBtn.textContent = "â˜€ï¸ Light Mode";
      } else {
        document.body.classList.remove("dark");
        darkModeBtn.textContent = "ðŸŒ™ Dark Mode";
      }
    }
    darkModeBtn.addEventListener("click", () => {
      setDarkMode(!document.body.classList.contains("dark"));
      localStorage.setItem("darkMode", document.body.classList.contains("dark"));
    });

    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    const savedDark = localStorage.getItem("darkMode");
    if (savedDark !== null) {
      setDarkMode(savedDark === "true");
    } else {
      setDarkMode(prefersDark);
    }

    loadData();
  </script>
</body>
</html>
